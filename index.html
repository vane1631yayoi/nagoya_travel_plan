<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—…éŠè¡Œç¨‹è¨ˆç•« - ç¾ä»£å¡ç‰‡è¦–è¦ºç‰ˆ (åªä¿ç•™è¡Œææ¸…å–®)</title>
    <!-- å¼•å…¥ Tailwind CSS ç¢ºä¿éŸ¿æ‡‰å¼è¨­è¨ˆå’Œæ¸…æ™°æ’ç‰ˆ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* è¼‰å…¥ Inter å­—é«”ï¼Œç¢ºä¿æ¸…æ™°åº¦ */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* æ·ºç°è‰²èƒŒæ™¯ */
            color: #1e293b; 
        }
        /* ä¸»é«”è‰²èª¿ï¼šæ·±è—/ç´« */
        .primary-bg {
            background-color: #4f46e5; /* é›è—è‰² */
        }
        .primary-text {
            color: #4f46e5;
        }
        /* å°è¦½æŒ‰éˆ•æ¨£å¼ */
        .tab-button {
            transition: all 0.2s;
            min-width: 130px;
            height: 80px;
            font-size: 1.125rem; /* text-lg */
        }
        .tab-active {
            box-shadow: 0 4px 14px rgba(79, 70, 229, 0.4);
            border: 2px solid white;
            transform: scale(1.05);
            font-weight: bold;
        }
        /* è¡Œç¨‹å¡ç‰‡æ¨£å¼ */
        .itinerary-card {
            border-left: 5px solid #4f46e5; 
            transition: all 0.2s;
        }
        /* å¯é»æ“Šåœ°åœ–çš„å…ƒç´ æ¨£å¼ */
        .map-clickable {
            cursor: pointer;
            text-decoration: underline;
            color: #1e40af; /* æ·±è—è‰² */
            font-weight: bold;
        }
        /* é£¯åº—è³‡è¨Šå¡ç‰‡ */
        .hotel-card {
            background-color: #eef2ff; /* æ·ºé›è—è‰² */
            border: 1px solid #c7d2fe;
        }
        /* Modal æ¨£å¼ */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            transition: opacity 0.3s ease;
        }

        /* è¡Œææ¸…å–®é …ç›®æ¨£å¼ */
        .packing-item {
            transition: background-color 0.15s, transform 0.15s;
            margin-top: 8px;
        }
        .packing-item.checked {
            text-decoration: line-through;
            opacity: 0.6;
            background-color: #f3f4f6;
        }
    </style>
    <script>
        // è¨­å®š Tailwind é…ç½®ä»¥ä½¿ç”¨è‡ªå®šç¾©é¡è‰²
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-blue': '#4f46e5',
                        'secondary-card': '#eef2ff',
                    },
                }
            }
        }
    </script>
</head>
<body>
    
    <!-- ä¸» Header å€åŸŸ -->
    <header class="primary-bg p-6 pb-20 shadow-2xl relative">
        <div class="max-w-4xl mx-auto flex justify-between items-start">
            <!-- æ¨™é¡Œå€ -->
            <div>
                <h1 class="text-3xl font-extrabold text-white">
                    âœˆï¸ åå¤å±‹ä¹‹æ—…
                </h1>
                <p class="text-lg text-indigo-200 mt-1">
                    3æœˆ13æ—¥ - 3æœˆ19æ—¥
                </p>
            </div>
            
            <!-- Icon å€åŸŸ (å³ä¸Šæ–¹) - åªä¿ç•™è¡Œææ¸…å–® -->
            <div class="flex space-x-4 mt-1 text-white">
                <!-- è¡Œææ¸…å–® Icon -->
                <button id="packing-list-icon-button"
                        class="p-2 rounded-full hover:bg-indigo-600 transition duration-150 transform hover:scale-110"
                        title="è¡Œææ¸…å–®">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-case-sensitive"><path d="m3 15 4-8 4 8"/><path d="M4 13h6"/><path d="M15 15h3c.8 0 1.5-.7 1.5-1.5v-9c0-.8-.7-1.5-1.5-1.5h-2c-.8 0-1.5.7-1.5 1.5v7.5"/><path d="M15 7h4"/></svg>
                </button>
            </div>
        </div>
    </header>

    <!-- æ—¥æœŸåˆ‡æ› Tab å€ (å›ºå®šåœ¨é ‚éƒ¨ä¸‹æ–¹ï¼Œå¯å·¦å³æ»‘å‹•) -->
    <div class="sticky top-0 z-30 bg-primary-bg">
        <nav id="day-tabs" class="flex overflow-x-auto whitespace-nowrap p-2 -mt-12 max-w-4xl mx-auto">
            <!-- Tab æŒ‰éˆ•å°‡ç”± JS å‹•æ…‹ç”Ÿæˆ -->
        </nav>
    </div>

    <main id="itinerary-container" class="max-w-4xl mx-auto p-4 md:p-8 -mt-12">
        <!-- è¡Œç¨‹å…§å®¹å°‡ç”± JavaScript æ¸²æŸ“ -->
    </main>

    <footer class="p-6 mt-8 bg-gray-700 text-white text-center">
        <p class="text-base">ç¥æ‚¨æ—…é€”å¹³å®‰æ„‰å¿«ï¼</p>
        <p id="user-id-display" class="text-xs mt-2 opacity-75">Loading User ID...</p>
    </footer>

    <!-- ------------------------------------------------------------------- -->
    <!-- Modal: è¡Œææ¸…å–® (Packing List) -->
    <!-- ------------------------------------------------------------------- -->
    <div id="packing-list-modal" class="modal-overlay fixed inset-0 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto transform transition-all p-6 md:p-8">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-3xl font-bold primary-text">ğŸ§³ è¡Œææ¸…å–®</h2>
                <!-- é—œé–‰æŒ‰éˆ• -->
                <button onclick="toggleModal('packing-list-modal')" class="text-gray-500 hover:text-gray-900 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 15 6-6"/></svg>
                </button>
            </div>

            <!-- æ¸…å–®å…§å®¹å€ -->
            <div id="packing-list-content" class="space-y-4 pt-2">
                <!-- æ¸…å–®é …ç›®å°‡ç”± JS/Firestore æ¸²æŸ“ -->
                <div class="text-center text-gray-500 py-10">
                    <p id="packing-loading-message">è¼‰å…¥ä¸­...</p>
                </div>
            </div>
            
            <div class="mt-8 text-sm text-gray-500 p-2 border-t pt-4">
                <p>ğŸ’¡ é»æ“Šé …ç›®å³å¯å‹¾é¸/å–æ¶ˆï¼Œæ¸…å–®æœƒè‡ªå‹•å„²å­˜ä¸¦åŒæ­¥ã€‚</p>
            </div>
        </div>
    </div>

    <!-- JavaScript ç¨‹å¼ç¢¼ - ç§»è‡³ body çµå°¾ï¼Œç¢ºä¿ DOM å…ƒç´ å·²è¼‰å…¥ -->
    <script type="module">
        // Firebase ç›¸é—œå¼•å…¥
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Firestore å¿…é ˆä½¿ç”¨çš„å…¨åŸŸè®Šæ•¸
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;

        // --- æ–°çš„æ¸…å–®è³‡æ–™çµæ§‹ ---
        const PACKING_COLLECTION_PATH = `/artifacts/${appId}/users`;
        const PACKING_DOC_NAME = 'main_list'; 

        // é è¨­æ¸…å–® (åˆ†ç‚ºå…©é¡)
        const DEFAULT_PACKING_LIST = {
            carryOn: [
                { id: crypto.randomUUID(), name: 'è­·ç…§èˆ‡ç°½è­‰', checked: false, category: 'carryOn' },
                { id: crypto.randomUUID(), name: 'ç™»æ©Ÿè­‰ / é›»å­æ©Ÿç¥¨', checked: false, category: 'carryOn' },
                { id: crypto.randomUUID(), name: 'æ—¥å¹£ç¾é‡‘ / ä¿¡ç”¨å¡', checked: false, category: 'carryOn' },
                { id: crypto.randomUUID(), name: 'æ‰‹æ©Ÿ / å……é›»å™¨ / è¡Œå‹•é›»æº', checked: false, category: 'carryOn' },
                { id: crypto.randomUUID(), name: 'éš¨èº«è—¥å“', checked: false, category: 'carryOn' },
                { id: crypto.randomUUID(), name: 'ç·Šæ€¥æ›æ´—è¡£ç‰© (T-shirt)', checked: false, category: 'carryOn' },
            ],
            checkedLuggage: [
                { id: crypto.randomUUID(), name: 'æ›æ´—è¡£ç‰© (7å¤©)', checked: false, category: 'checkedLuggage' },
                { id: crypto.randomUUID(), name: 'é˜²æ°´/ä¿æš–å¤–å¥—', checked: false, category: 'checkedLuggage' },
                { id: crypto.randomUUID(), name: 'ç›¥æ´—ç”¨å“ (å¤§ç“¶è£)', checked: false, category: 'checkedLuggage' },
                { id: crypto.randomUUID(), name: 'è½‰æ›æ’é ­ / å»¶é•·ç·š', checked: false, category: 'checkedLuggage' },
                { id: crypto.randomUUID(), name: 'æ—…è¡Œç”¨æ¯›å·¾', checked: false, category: 'checkedLuggage' },
                { id: crypto.randomUUID(), name: 'ç©ºçš„ä¿æº«ç“¶/æ°´å£º', checked: false, category: 'checkedLuggage' },
                { id: crypto.randomUUID(), name: 'åŒ–å¦å“/ä¿é¤Šå“', checked: false, category: 'checkedLuggage' },
            ]
        };
        
        // ç‹€æ…‹å„²å­˜ç‚ºç‰©ä»¶
        let packingList = {};


        // --- Firebase åˆå§‹åŒ–èˆ‡èªè­‰ ---
        function initFirebase() {
            if (!firebaseConfig) {
                console.error("Firebase config is missing.");
                return;
            }
            
            setLogLevel('debug'); // é–‹å•Ÿ Firestore Debug Log
            
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            // ç›£è½èªè­‰ç‹€æ…‹ï¼Œä¸€æ—¦ç™»å…¥å®Œæˆï¼Œå°±è¨­å®š userId ä¸¦é–‹å§‹è¼‰å…¥è³‡æ–™
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    isAuthReady = true;
                    document.getElementById('user-id-display').textContent = `User ID: ${userId}`;
                    console.log("Firebase Auth Ready. User ID:", userId);
                    startDataListeners(); // èªè­‰å®Œæˆå¾Œï¼Œé–‹å§‹ç›£è½ Firestore
                } else {
                    // å¦‚æœæ²’æœ‰ç”¨æˆ¶ï¼Œä½†èªè­‰æµç¨‹èµ°å®Œ (åŒ¿åç™»å…¥æˆ–è‡ªå®šç¾© token å¤±æ•—)ï¼Œä¹Ÿæ¨™è¨˜ç‚º Ready
                    userId = null;
                    isAuthReady = true; 
                    document.getElementById('user-id-display').textContent = 'User ID: Anonymous (Data not loaded)';
                    console.log("Firebase Auth Ready. User signed out.");
                }
            });

            // åŸ·è¡Œç™»å…¥æµç¨‹
            if (initialAuthToken) {
                signInWithCustomToken(auth, initialAuthToken)
                    .catch((error) => {
                        console.error("Custom token sign-in failed:", error);
                        // å¦‚æœè‡ªå®šç¾© token å¤±æ•—ï¼Œå˜—è©¦åŒ¿åç™»å…¥ä½œç‚º fallback
                        signInAnonymously(auth).catch(err => console.error("Anonymous sign-in failed:", err));
                    });
            } else {
                // å¦‚æœæ²’æœ‰æä¾› tokenï¼Œå‰‡åŒ¿åç™»å…¥
                signInAnonymously(auth).catch(err => console.error("Anonymous sign-in failed:", err));
            }
        }

        // --- Firestore è³‡æ–™æ“ä½œ ---

        /**
         * ç²å– Packing List æ–‡ä»¶åƒè€ƒ
         */
        function getPackingDocRef() {
            if (!db || !userId) {
                console.error("Database or User ID not ready.");
                return null;
            }
            // å­˜å„²è·¯å¾‘: /artifacts/{appId}/users/{userId}/packing_list/main_list
            const packingListPath = `${PACKING_COLLECTION_PATH}/${userId}/packing_list/${PACKING_DOC_NAME}`;
            return doc(db, packingListPath);
        }

        /**
         * ç›£è½ä¸¦åŒæ­¥ Packing List è³‡æ–™
         */
        function startDataListeners() {
            if (!isAuthReady || !userId || !db) return;

            const docRef = getPackingDocRef();
            if (!docRef) return;

            onSnapshot(docRef, (docSnap) => {
                const loadingMessage = document.getElementById('packing-loading-message');
                if (loadingMessage) loadingMessage.classList.add('hidden');
                
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    // ç¢ºä¿è¼‰å…¥çš„è³‡æ–™ç¬¦åˆæ–°çµæ§‹
                    packingList.carryOn = data.carryOn || [];
                    packingList.checkedLuggage = data.checkedLuggage || [];
                    console.log("Packing List loaded:", packingList);
                } else {
                    // å¦‚æœæ–‡æª”ä¸å­˜åœ¨ï¼Œä½¿ç”¨é è¨­æ¸…å–®ä¸¦å˜—è©¦å„²å­˜
                    packingList = DEFAULT_PACKING_LIST;
                    savePackingList(packingList);
                    console.log("No packing list found. Initializing with default.");
                }
                renderPackingList(); // æ¯æ¬¡è³‡æ–™æ›´æ–°æ™‚é‡æ–°æ¸²æŸ“
            }, (error) => {
                console.error("Error listening to packing list:", error);
                const loadingMessage = document.getElementById('packing-loading-message');
                if (loadingMessage) {
                    loadingMessage.textContent = 'è³‡æ–™è¼‰å…¥éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥é€£ç·šã€‚';
                    loadingMessage.classList.remove('hidden');
                }
            });
        }

        /**
         * å°‡ç•¶å‰çš„ packingList (æ•´å€‹ç‰©ä»¶) å¯«å…¥ Firestore
         * @param {Object} listObject - åŒ…å« carryOn å’Œ checkedLuggage çš„æ¸…å–®ç‰©ä»¶
         */
        async function savePackingList(listObject) {
            const docRef = getPackingDocRef();
            if (!docRef) {
                console.warn("Cannot save packing list: Doc reference not ready.");
                return;
            }
            try {
                // ä½¿ç”¨ setDoc è¦†è“‹æ¸…å–®
                await setDoc(docRef, { ...listObject, lastUpdated: new Date() }, { merge: false });
            } catch (error) {
                console.error("Failed to save packing list:", error);
            }
        }

        // --- Packing List äº’å‹•é‚è¼¯ ---

        /**
         * åˆ‡æ›é …ç›®çš„å‹¾é¸ç‹€æ…‹ (ç¾åœ¨éœ€è¦çŸ¥é“æ˜¯å“ªå€‹é¡åˆ¥)
         * @param {string} itemId - é …ç›® UUID
         * @param {string} category - é¡åˆ¥ ('carryOn' æˆ– 'checkedLuggage')
         */
        window.togglePackingItem = function(itemId, category) {
            // ç¢ºä¿é¡åˆ¥å­˜åœ¨
            if (!packingList[category]) return;

            const itemIndex = packingList[category].findIndex(item => item.id === itemId);
            if (itemIndex > -1) {
                // åˆ‡æ›ç‹€æ…‹
                packingList[category][itemIndex].checked = !packingList[category][itemIndex].checked;
                // å„²å­˜åˆ° Firestore
                savePackingList(packingList); 
            }
        }
        
        // --- Packing List UI æ¸²æŸ“ ---

        /**
         * æ¸²æŸ“ Packing List Modal å…§å®¹
         */
        function renderPackingList() {
            const content = document.getElementById('packing-list-content');
            if (!content) return;
            
            // Helper function to render a category
            const renderCategory = (title, items) => {
                let html = `<h3 class="text-xl font-bold primary-text mt-6 mb-2 border-b-2 border-primary-blue pb-1">${title}</h3>`;
                
                // æ’åºï¼šæœªå‹¾é¸çš„åœ¨å‰ï¼Œå·²å‹¾é¸çš„åœ¨å¾Œ
                const sortedItems = [...items].sort((a, b) => {
                    if (a.checked === b.checked) return 0;
                    return a.checked ? 1 : -1;
                });

                if (sortedItems.length === 0) {
                    html += `<p class="text-gray-500 py-2">æ­¤é¡åˆ¥ç„¡é …ç›®ã€‚</p>`;
                } else {
                    html += `<div class="space-y-2">`;
                    html += sortedItems.map(item => `
                        <div class="packing-item p-3 rounded-lg shadow-sm flex items-center cursor-pointer border border-gray-200 transition duration-150 ${item.checked ? 'checked' : 'bg-white hover:shadow-md'}" 
                             onclick="togglePackingItem('${item.id}', '${item.category}')">
                            
                            <!-- Checkbox Icon (æ–¹å¡Šå‹¾é¸) -->
                            <div class="flex-shrink-0 mr-4 text-2xl">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="${item.checked ? 'text-green-500' : 'text-gray-400'}">
                                    ${item.checked 
                                        ? '<rect width="18" height="18" x="3" y="3" rx="4"/><path d="m9 12 2 2 4-4"/>' 
                                        : '<rect width="18" height="18" x="3" y="3" rx="4"/>'
                                    }
                                </svg>
                            </div>

                            <!-- é …ç›®åç¨± -->
                            <span class="text-base text-gray-800 font-medium truncate flex-1 leading-relaxed">
                                ${item.name}
                            </span>
                        </div>
                    `).join('');
                    html += `</div>`;
                }
                return html;
            };
            
            // Check if data is loaded
            if (!packingList.carryOn && !packingList.checkedLuggage) {
                content.innerHTML = `<p class="text-center text-gray-500 py-6">è¼‰å…¥ä¸­...</p>`;
                return;
            }

            let finalHTML = '';
            // éš¨èº«è¡Œæ (Carry-on)
            finalHTML += renderCategory('éš¨èº«è¡Œæ (Carry-on)', packingList.carryOn || []);
            // æ‰˜é‹è¡Œæ (Checked Luggage)
            finalHTML += renderCategory('æ‰˜é‹è¡Œæ (Checked Luggage)', packingList.checkedLuggage || []);
            
            content.innerHTML = finalHTML;
        }


        // --- æ ¸å¿ƒå·¥å…·å‡½å¼ ---

        /**
         * é–‹å•Ÿ Google Map æœå°‹æŒ‡å®šåœ°é»
         * @param {string} query - åœ°åœ–æœå°‹çš„é—œéµå­—
         */
        window.openGoogleMap = function(query) {
            if (query) {
                const url = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(query)}`;
                window.open(url, '_blank');
            }
        };

        /**
         * æ§åˆ¶ Modal å½ˆå‡ºè¦–çª—çš„é¡¯ç¤º/éš±è—
         * @param {string} modalId - Modal å…ƒç´ çš„ ID
         */
        window.toggleModal = function(modalId) {
            const modal = document.getElementById(modalId);
            if (modal.classList.contains('hidden')) {
                modal.classList.remove('hidden');
                document.body.style.overflow = 'hidden'; // é˜»æ­¢èƒŒæ™¯æ»¾å‹•
                if (modalId === 'packing-list-modal') {
                    renderPackingList(); // æ¯æ¬¡æ‰“é–‹æ¸…å–®æ™‚é‡æ–°æ¸²æŸ“
                }
            } else {
                modal.classList.add('hidden');
                document.body.style.overflow = '';
            }
        }

        // --- è¡Œç¨‹æ•¸æ“šèˆ‡æ¸²æŸ“é‚è¼¯ (ä¿ç•™èˆŠæœ‰åŠŸèƒ½) ---
        const HOTEL_NAME = "Fresa Inn (INN åå¤å±‹é§…æ«»é€šå£)";
        const HOTEL_ADDRESS = "4 Chome-4-15 Meieki, Nakamura Ward, Nagoya, Aichi 450-0002æ—¥æœ¬";
        const HOTEL_MAP_QUERY = "Fresa Inn åå¤å±‹é§…æ«»é€šå£";

        const travelItinerary = [
            {
                day: "Day 1",
                date: "3/13 (äº”)",
                theme: "TPEå•Ÿç¨‹èˆ‡æŠµé”åå¤å±‹",
                weather: "æ™´æœ—, 18Â°C",
                events: [
                    { time: "15:15", activity: "æ¡ƒåœ’æ©Ÿå ´ç¬¬äºŒèˆªå»ˆé›†åˆ", note: "è«‹ç¢ºèªæ‰‹æ©Ÿ/è­·ç…§/é›»å­æ©Ÿç¥¨", location: "æ¡ƒåœ’åœ‹éš›æ©Ÿå ´ ç¬¬äºŒèˆªå»ˆ" },
                    { time: "17:15", activity: "TPE èµ·é£›", note: "ç­æ©Ÿä»£è™Ÿ:CI150" },
                    { time: "19:00", activity: "æ™šé¤", note: "é£›æ©Ÿé¤" },
                    { time: "21:05", activity: "æŠµé”åå¤å±‹", note: "é ˜å–è¡Œæï¼Œæº–å‚™ VISIT JAPAN QR CODE", location: "ä¸­éƒ¨åœ‹éš›æ©Ÿå ´" },
                    { time: "21:37", activity: "è½‰ä¹˜åéµ", note: "éœ€è¦è²·å°è™Ÿåº§", location: "åå¤å±‹è»Šç«™" },
                    { time: "22:57", activity: "å…¥ä½ " + HOTEL_NAME, note: "ä¸­å¤®å‰ªç¥¨å£å‡ºç«™èµ°4åˆ†é˜", location: HOTEL_MAP_QUERY }
                ],
                hotel: HOTEL_ADDRESS,
                hotelMapQuery: HOTEL_MAP_QUERY
            },
            {
                day: "Day 2",
                date: "3/14 (å…­)",
                theme: "æ–‡åŒ–èˆ‡æ­·å²æ¢ç´¢",
                weather: "å¤šé›², 15Â°C",
                events: [
                    { time: "8:00", activity: "æ—©é¤", note: "Komedaå®¢å¤šç¾å’–å•¡ OR SHINPACHIæ—¥å¼çƒ¤é­šæ—©é¤"},
                    { time: "9:30", activity: "åå¤å±‹ç§‘å­¸é¤¨", note: "æå‰è²·å…­/æ—¥çš„å‘¨æœ«ç’°ä¿åˆ¸(å¯æ­åœ°éµ/å·´å£«)", location: "åå¤å±‹ç§‘å­¸é¤¨" },
                    { time: "12:00", activity: "åˆé¤", note: "é£›é¨¨ç‰›ç‡’è‚‰ åˆé–“å¥—é¤", location: "ç‡’è‚‰ é¦¬å–°ä¸€ä»£ åå¤å±‹EAST" },
                    { time: "13:30", activity: "ç†±ç”°ç¥å®®", note: "æ­ä¹˜ååŸç·šå‰å¾€ ç†±ç”°ç¥å®®è¥¿", location: "ç†±ç”°ç¥å®®" },
                    { time: "14:30", activity: "ç†±ç”°ç¥å®® å¯¶ç‰©é¤¨", note: "500æ—¥åœ“é–€ç¥¨", location: "ç†±ç”°ç¥å®® å¯¶ç‰©é¤¨" },
                    { time: "16:00", activity: "Aeonè³¼ç‰© æˆ– æ¦®ç”ºé€›è¡—", note: "Aeonæœ‰è¶…å¸‚/æ¦®æœ‰ç™¾è²¨" },
                    { time: "19:00", activity: "æ™šé¤", note: "å¾·å…µè¡›è¿´è½‰å£½å¸ OR ç¾ç™»åˆ©å£½å¸" }
                ],
                hotel: HOTEL_ADDRESS,
                hotelMapQuery: HOTEL_MAP_QUERY
            },
            {
                day: "Day 3",
                date: "3/15 (æ—¥)",
                theme: "å‰åœåŠ›å…¬åœ’ä¹‹æ—…(æ”œå¸¶è­·ç…§)",
                weather: "æ™´æœ—, 16Â°C",
                events: [
                    { time: "7:00", activity: "æ—©é¤", note: "ä¾¿åˆ©å•†åº— OR å‰ä¸€å¤©å…ˆè²·" },
                    { time: "7:30", activity: "åå¤å±‹è»Šç«™ --> è—¤ä¸˜(æ±å±±ç·š) --> æ„›åœ°çƒç´€å¿µå…¬åœ’(LINIMO)", note: "ä½¿ç”¨å‘¨æœ«ç’°ä¿åˆ¸+SUICA", location: "åå¤å±‹è»Šç«™" },
                    { time: "9:00", activity: "å‰åœåŠ›å…¬åœ’ å¤§å€‰åº«", note: "é ˆå¸¶è­·ç…§é©—ç¥¨", location: "Ghibliâ€™s Grand Warehouse" },
                    { time: "12:00", activity: "åˆé¤", note: "åœ’å€å…§çš„MOS Burge", location: "ãƒ¢ã‚¹ãƒãƒ¼ã‚¬ãƒ¼ ã‚­ãƒƒãƒãƒ³ã‚«ãƒ¼KC3" },
                    { time: "12:30", activity: "é­”å¥³ä¹‹è°·", note: "é­”å¥³ä¹‹å®¶ (å®‰é›…èˆ‡é­”å¥³)/ éœçˆ¾çš„ç§»å‹•åŸå ¡/ æ­å¥‡è«¾ä¹‹å®¶ (å¤©ç©ºä¹‹åŸ)", location: "é­”å¥³ã®è°·" },
                    { time: "15:00", activity: "å‹•å‹•åŠ›ä¹‹æ£® (æ­å…¬è»Š)", note: "å°æœˆèˆ‡å°æ¢…ä¹‹å®¶" , location: "ã©ã‚“ã©ã“æ£®"},
                    { time: "15:30", activity: "é­”æ³•ä¹‹é‡Œ(æ­å…¬è»Š)", note: "æ™‚é–“ä¸å¤ å¯è·³é" , location: "ã‚‚ã®ã®ã‘ã®é‡Œ" },
                    { time: "16:20", activity: "é’æ˜¥ä¹‹ä¸˜" , note: "è²“å’ªäº‹å‹™æ‰€(è²“çš„å ±æ©)/ åœ°çƒå±‹(å¿ƒä¹‹è°·)" , location: "é’æ˜¥ã®ä¸˜" },
                    { time: "19:30", activity: "æ™šé¤ (è¿‘æ¸…æ°´ç«™)", note: "ä¸²éŠ€ åŠ(çƒ¤é›è‚‰ä¸²) OR ãªã¾ã‚‰ã‚€ãƒ¼ã¡ã‚‡(ç¾Šè‚‰ç‡’è‚‰)", location: "ãªã¾ã‚‰ã‚€ãƒ¼ã¡ã‚‡" }
                ],
                hotel: HOTEL_ADDRESS,
                hotelMapQuery: HOTEL_MAP_QUERY
            },
            {
                day: "Day 4",
                date: "3/16 (ä¸€)",
                theme: "çŠ¬å±±åŸä¹‹æ—…",
                weather: "å¤šé›², 15Â°C",
                events: [
                    { time: "8:20", activity: "æ—©é¤ + åƒåŠ å…­ä¹‹å¸‚", note: "åˆ·SUICAæ­åéµç·šåˆ° æœ¬ç¬ å¯º(4è™Ÿæœˆå°)", location: "ç¬ å¯ºè¦³éŸ³ï¼ˆç¬ è¦†å¯ºï¼‰"  },
                    { time: "9:00", activity: "Workmanæ¡è²·é˜²æ°´è£å‚™", note: "é˜²æ°´é‹/ é˜²é¢¨é˜²æ°´å¤–å¥—", location: "ãƒ¯ãƒ¼ã‚¯ãƒãƒ³ åå¤å±‹ç¬ å¯ºåº—" },
                    { time: "11:00", activity: "åˆé¤ ", note: "harbs åˆé–“å¥—é¤(ä¸èƒ½è¨‚ä½)", location: "ãƒãƒ¼ãƒ–ã‚¹ æ „æœ¬åº—" },
                    { time: "12:30", activity: "è²·çŠ¬å±±åŸå¥—ç¥¨", note: "åéµå”®ç¥¨å£ï¼Œé †ä¾¿å»è²·è‰¾è¨±å¥¶æ²¹æ³¡èŠ™", location: "åå¤å±‹è»Šç«™" },
                    { time: "13:40", activity: "çŠ¬å±±åŸ", note: "æ­ç‰¹æ€¥åˆ°çŠ¬å±±éŠåœ’åœ°", location: "çŠ¬å±±åŸ" },
                    { time: "15:00", activity: "åŸä¸‹ç”ºé€›è¡—", note: "ä¸‰å…‰ç¨»è·ç¥ç¤¾ é«”é©—æ´—éŒ¢(100ç¾Š)" },
                    { time: "17:00", activity: "æ™šé¤", note: "è“¬ãœã‚“ é°»é­šæ–™, é †è·¯è²· å°¾å¼µçŠ¬å±±è“åŒ ", location:"è“¬ãœã‚“ é°»é­šæ–™ç†" }
                ],
                hotel: HOTEL_ADDRESS,
                hotelMapQuery: HOTEL_MAP_QUERY
            },
            {
                day: "Day 5",
                date: "3/17 (äºŒ)",
                theme: "ä¸­å±±é“ - å¦»ç± å®¿èˆ‡é¦¬é¾å®¿",
                weather: "é™£é›¨, 12Â°C",
                events: [
                    { time: "7:30", activity: "æ—©é¤", note: "å‰ä¸€å¤©å…ˆé»é¤ï¼Œè»Šä¸Šåƒ", location: "ãƒã‚¯ãƒ‰ãƒŠãƒ«ãƒ‰ åå¤å±‹ã‚²ãƒ¼ãƒˆã‚¦ã‚©ãƒ¼ã‚¯åº—" },
                    { time: "8:00", activity: "äº¤é€š (å‰å¾€é¦¬ç± )", note: "æ­ä¹˜JRä¿¡æ¿ƒ åˆ°ä¸­å·æ´¥è»Šç«™ -> è½‰æ­ Magomeå·´å£« åˆ° Magome " },
                    { time: "9:35", activity: "é¦¬ç± å®¿ æ•£æ­¥", note: "å¯ä»¥è²·ä¸­å±±é“è­‰æ˜", location: "é¦¬ç± å®¿" },
                    { time: "10:30", activity: "åˆé¤", note: "ãŠé£Ÿäº‹å‡¦ æ¨¹æ¢¨, ä¸é¤“å¯ä»¥ä¸åƒæˆ–é»äº”å¹³é¤…ç­‰å°æ±è¥¿", location: "ãŠé£Ÿäº‹å‡¦ æ¨¹æ¢¨" },
                    { time: "11:30", activity: "é¦¬ç± å®¿ èµ°åˆ° å¦»ç± å®¿", note: "6.5km" },
                    { time: "14:30", activity: "å¦»ç± å®¿ æ•£æ­¥", note: "å¯è“‹ç« ä¸­å±±é“è­‰æ˜", location: "GOOD DAY Cafe" },                    
                    { time: "15:20", activity: "äº¤é€š(å›åå¤å±‹è»Šç«™)", note: "æ­é«˜é€Ÿå·´å£« éœ€é ç´„" , location: "ã€’399-5302 é•·é‡çœŒæœ¨æ›½éƒ¡å—æœ¨æ›½ç”ºå¾å¦»"},
                    { time: "17:30", activity: "æ™šé¤", note: "çŸ¢å ´è±¬æ’ or æ³•å¼è±¬æ’ katuretu matumura or é›ç¿… ä¸–ç•Œçš„å±±åŒ ", location: "ã‚«ãƒ„ãƒ¬ãƒ„MATUMURA" },
                    { time: "æœ‰åŠ›æ°£çš„è©±", activity: "æ³¡æ¹¯", note: "Canal resort(åå¤å±‹é§›) or Urban Quar(æ¦®)æ³¡æ¹¯ï¼Œæœ‰ç„¡æ–™é€è¿å·´å£«!", location: "ã‚­ãƒ£ãƒŠãƒ«ãƒ»ãƒªã‚¾ãƒ¼ãƒˆ" }                  
                ],
                hotel: HOTEL_ADDRESS,
                hotelMapQuery: HOTEL_MAP_QUERY
            },
            {
                day: "Day 6",
                date: "3/18 (ä¸‰)",
                theme: "å¸‚é›†+é€›è¡—æ—¥",
                weather: "æ™´æœ—, 17Â°C",
                events: [
                    { time: "7:50", activity: "æ—©é¤", note: "æˆ‘å…ˆææ—©å»æ’éšŠ", location: "å¤©ç„¶é…µæ¯ã®é£Ÿãƒ‘ãƒ³å°‚é–€åº— ã¤ã°ã‚ãƒ‘ãƒ³ï¼†Milk åé§…åº—" },
                    { time: "9:30", activity: "å¤§é ˆè§€éŸ³éª¨è‘£å¸‚é›† + å•†åœˆ", note: "é’æŸ³ç¸½æœ¬å®¶/ç¯‰åœ°éŠ€ç« é­š/è¦ºç‹å±±æ°´æœå¤§ç¦/osu bakery", location: "å¤§é ˆè¦³éŸ³" },
                    { time: "11:30", activity: "åˆé¤", note: "å¤§é ˆè§€éŸ³ suzuyaç‚¸è±¬æ’(è¦æ’éšŠ) OR é‡‘å±± ç‡’è‚‰äºŒéƒ(å¯é ç´„)", location: "ç„¼è‚‰&æ‰‹æ‰“ã¡å†·éºº äºŒéƒ KANAYAMA" },
                    { time: "ä¸‹åˆæ™‚æ®µ", activity: "è‡ªç”±æ´»å‹•/æ•´ç†è¡Œæ", note: "é ç•™å……è¶³æ™‚é–“æ•´ç†è¡Œæèˆ‡ä¼‘æ¯" },
                    { time: "17:00", activity: "æ™šé¤", note: "è‡ªè¡Œè™•ç†" }
                ],
                hotel: HOTEL_ADDRESS,
                hotelMapQuery: HOTEL_MAP_QUERY
            },
            {
                day: "Day 7",
                date: "3/19 (å››)",
                shortDate: "3/19",
                theme: "ğŸ‘‹ æ­¸ç¨‹æ—¥",
                weather: "æ™´æœ—, 19Â°C",
                events: [
                    { time: "8:00", activity: "Check out", note: "æª¢æŸ¥æ‰‹æ©ŸéŒ¢åŒ…è­·ç…§ & è¡Œæç§¤é‡" },
                    { time: "8:30", activity: "æ­ä¹˜åéµç‰¹æ€¥(éƒ¨åˆ†å°è™Ÿåº§)åå¤å±‹æ©Ÿ", note: "å¯åˆ·suicaåè‡ªç”±åº§" },
                    { time: "9:11", activity: "è¯èˆª CHECK IN ", location: "æŠµé”åå¤å±‹æ©Ÿå ´ ç¬¬ä¸€èˆªå»ˆ" },
                    { time: "9:30", activity: "æ©Ÿå ´æ¡è³¼", note: "ä»™è²è¦ä¹‹é‡Œ", location: "ä»™è²è¦ä¹‹é‡Œ" },
                    { time: "10:00", activity: "åˆé¤", note: "T1 4Fæœ‰å¾ˆå¤šé¸æ“‡", location:"åŠè—è£½éºµ" },
                    { time: "10:30", activity:"éå®‰æª¢", note: "å¾Œé¢æœ‰å…ç¨…è³¼ç‰©" },
                    { time: "11:25", activity: "ç™»æ©Ÿ", note: "12:05 èµ·é£›" },
                    { time: "14:40", activity: "TPE é™è½", note: "å¹³å®‰æŠµé”å°ç£", location: "æ¡ƒåœ’åœ‹éš›æ©Ÿå ´" }
                ],
                hotel: "æœ¬æ—¥ç‚ºè¿”ç¨‹æ—¥ï¼Œç„¡ä½å®¿å®‰æ’ã€‚ç¥æ‚¨æ—…é€”é †åˆ©ï¼",
                hotelMapQuery: null 
            }
        ];

        const container = document.getElementById('itinerary-container');
        const tabsContainer = document.getElementById('day-tabs');


        // *** åˆªé™¤ renderItineraryOverview ç›¸é—œå‡½å¼ ***


        /**
         * æ¸²æŸ“ç‰¹å®šæ—¥æœŸçš„è¡Œç¨‹
         * @param {number} dayIndex - è¡Œç¨‹åœ¨ travelItinerary é™£åˆ—ä¸­çš„ç´¢å¼• (0 = Day 1)
         */
        function renderItinerary(dayIndex) {
            const dayPlan = travelItinerary[dayIndex];
            
            // æ¸…ç©ºèˆŠå…§å®¹
            container.innerHTML = ''; 

            // 1. é ‚éƒ¨æ—¥æœŸ/å¤©æ°£å¡ç‰‡ (æ¨¡æ“¬åœ–ç‰‡é¢¨æ ¼)
            const dateWeatherCard = document.createElement('div');
            dateWeatherCard.className = 'bg-white p-6 rounded-xl shadow-lg flex justify-between items-center mb-6';
            
            // è™•ç†å¤©æ°£åœ–æ¨™
            let weatherIcon = 'â˜€ï¸';
            if (dayPlan.weather.includes('é›¨') || dayPlan.weather.includes('é™£é›¨')) {
                 weatherIcon = 'ğŸŒ§ï¸';
            } else if (dayPlan.weather.includes('å¤šé›²')) {
                weatherIcon = 'â˜ï¸';
            } else if (dayPlan.weather.includes('æ™´æœ—')) {
                weatherIcon = 'â˜€ï¸';
            }

            dateWeatherCard.innerHTML = `
                <div>
                    <p class="text-3xl font-extrabold primary-text">${dayPlan.date}</p>
                    <p class="text-xl text-gray-700">${dayPlan.theme}</p>
                </div>
                <div class="text-right">
                    <p class="text-4xl text-yellow-500">${weatherIcon}</p>
                    <p class="text-2xl font-bold primary-text">${dayPlan.weather.split(',')[1] || '17Â°C'}</p>
                    <p class="text-sm text-gray-500">${dayPlan.weather.split(',')[0] || 'æ™´æœ—'}</p>
                </div>
            `;
            container.appendChild(dateWeatherCard);

            // 2. å‰µå»ºæ´»å‹•åˆ—è¡¨
            dayPlan.events.forEach(event => {
                const eventCard = document.createElement('div');
                eventCard.className = 'itinerary-card bg-white p-4 rounded-xl shadow-md mb-4 flex space-x-4 items-start';
                
                // è™•ç†æ´»å‹•åœ–æ¨™
                const activityIcon = event.activity.includes("äº¤é€š") ? 'ğŸš—' : 
                                    event.activity.includes("é¤") || event.activity.includes("äº«ç”¨æ—©é¤") ? 'ğŸ½ï¸' : 
                                    event.activity.includes("æ©Ÿå ´") || event.activity.includes("ç™»æ©Ÿ") ? 'âœˆï¸' : 
                                    event.activity.includes("è³¼ç‰©") || event.activity.includes("æ¡è³¼") ? 'ğŸ›ï¸' : 
                                    event.activity.includes("å…¥ä½") || event.activity.includes("Check out") ? 'ğŸ›ï¸' : 
                                    'ğŸ“';

                // è™•ç†æ´»å‹•åç¨±ï¼šå¦‚æœæ˜¯æ™¯é»ï¼Œå‰‡å¯é»æ“Š
                let activityHTML;
                if (event.location) {
                    // ä½¿ç”¨ span å…ƒç´ æ¨¡æ“¬é€£çµï¼Œä¸¦ç¶å®šé»æ“Šäº‹ä»¶
                    activityHTML = `
                        <span class="text-lg map-clickable hover:opacity-80 transition-opacity leading-snug" 
                              onclick="openGoogleMap('${event.location.replace(/'/g, "\\'")}')">
                            ${event.activity}
                        </span>
                    `;
                } else {
                    activityHTML = `<p class="text-lg font-bold text-gray-800 leading-snug">${event.activity}</p>`;
                }

                eventCard.innerHTML = `
                    <!-- å·¦å´ï¼šæ™‚é–“èˆ‡åœ–æ¨™ -->
                    <div class="flex-shrink-0 text-center w-20">
                        <p class="text-lg font-bold text-gray-600">${event.time}</p>
                        <p class="text-2xl mt-1">${activityIcon}</p>
                    </div>
                    
                    <!-- å³å´ï¼šæ´»å‹•å…§å®¹èˆ‡å‚™è¨» -->
                    <div class="flex-1 min-w-0">
                        ${activityHTML}
                        <!-- å‚™è¨» -->
                        <p class="mt-1 text-base text-gray-500 font-medium leading-snug">â–¶ ${event.note}</p>
                    </div>
                `;
                container.appendChild(eventCard);
            });

            // 3. é¡¯ç¤ºé£¯åº—åœ°å€å¡ç‰‡
            const hotelCard = document.createElement('div');
            hotelCard.className = 'hotel-card mt-8 p-6 rounded-xl shadow-lg';
            
            if (dayIndex === travelItinerary.length - 1) { // è™•ç†æœ€å¾Œä¸€å¤©è¿”ç¨‹æ—¥
                hotelCard.innerHTML = `
                    <p class="text-xl font-bold primary-text">âœ… ç•¶æ—¥è¡Œç¨‹å‚™è¨»</p>
                    <p class="text-lg mt-2 text-gray-700">${dayPlan.hotel}</p>
                `;
            } else { // é¡¯ç¤ºä½å®¿åœ°å€ï¼Œä½¿å…¶å¯é»æ“Š
                hotelCard.innerHTML = `
                    <p class="text-xl font-bold primary-text">ğŸ  ç•¶æ™šå…¥ä½é£¯åº— (é»æ“Šåœ°åœ–)</p>
                    <p class="text-lg font-semibold mt-2 map-clickable hover:opacity-80 transition-opacity"
                       onclick="openGoogleMap('${dayPlan.hotelMapQuery.replace(/'/g, "\\'")}')">
                        ${HOTEL_NAME}
                    </p>
                    <p class="text-base mt-1 leading-relaxed text-gray-600">${dayPlan.hotel}</p>
                `;
            }
            container.appendChild(hotelCard);

            // å°‡è¦–çª—æ²å‹•åˆ°è¡Œç¨‹å…§å®¹é ‚éƒ¨
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        /**
         * è™•ç†é»æ“Šäº‹ä»¶ï¼šåˆ‡æ›é¸ä¸­çš„ Tab å’Œé¡¯ç¤ºå…§å®¹
         */
        function selectDay(dayIndex) {
            // 1. æ›´æ–°æŒ‰éˆ•çš„ Active ç‹€æ…‹
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('tab-active', 'primary-bg', 'text-white');
                btn.classList.add('bg-white', 'text-gray-800');
            });
            // ç‚ºç•¶å‰é»æ“Šçš„æŒ‰éˆ•æ·»åŠ  active æ¨£å¼
            const currentBtn = document.getElementById(`day-tab-${dayIndex}`);
            if (currentBtn) {
                currentBtn.classList.remove('bg-white', 'text-gray-800');
                currentBtn.classList.add('tab-active', 'primary-bg', 'text-white');
                
                currentBtn.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
            }

            // 2. æ¸²æŸ“å°æ‡‰çš„è¡Œç¨‹å…§å®¹
            renderItinerary(dayIndex);
        }

        /**
         * å‹•æ…‹ç”Ÿæˆé ‚éƒ¨çš„ Tab æŒ‰éˆ•ä¸¦ç¶å®šäº‹ä»¶
         */
        function setupTabs() {
            travelItinerary.forEach((dayPlan, index) => {
                const button = document.createElement('button');
                button.id = `day-tab-${index}`;
                // åˆå§‹æ¨£å¼
                button.className = 'tab-button bg-white text-gray-800 rounded-xl shadow-md p-3 mx-2 flex-shrink-0';
                button.innerHTML = `
                    <p class="text-sm text-gray-500">${dayPlan.date.split(' ')[0]}</p>
                    <p class="text-lg font-semibold">${dayPlan.day}</p>
                `;
                
                // é»æ“Šäº‹ä»¶ï¼šå‘¼å« selectDay å‡½å¼
                button.addEventListener('click', () => selectDay(index));
                
                tabsContainer.appendChild(button);
            });
            
            // é è¨­é¸ä¸­ä¸¦é¡¯ç¤º Day 1
            selectDay(0);
        }

        /**
         * è¨­ç½® Icon æŒ‰éˆ•çš„é»æ“Šäº‹ä»¶ç›£è½å™¨ï¼Œç¢ºä¿ Modal èƒ½å¤ æ­£ç¢ºå½ˆå‡º
         */
        function setupModalListeners() {
            // *** åˆªé™¤ overviewBtn ç›¸é—œç¨‹å¼ç¢¼ ***
            const packingListBtn = document.getElementById('packing-list-icon-button');

            if (packingListBtn) {
                packingListBtn.addEventListener('click', () => toggleModal('packing-list-modal'));
            } else {
                console.error("éŒ¯èª¤: è¡Œææ¸…å–® Icon æŒ‰éˆ•æœªæ‰¾åˆ°ã€‚");
            }
        }

        // é é¢è¼‰å…¥å®Œæˆå¾ŒåŸ·è¡Œè¨­å®š
        window.onload = function() {
            initFirebase(); // åˆå§‹åŒ– Firebase
            setupTabs();
            setupModalListeners(); // åœ¨ DOM è¼‰å…¥å¾Œç¶å®šäº‹ä»¶
        };

    </script>
</body>
</html>

